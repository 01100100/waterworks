models:
  - name: staging
    description: >
      Takes JSON data from the bucket for each intersecting_waterway run and loads it into a staging table.
      This data is used to visualize which waterways a route has crossed. The data includes timestamps, 
      Strava activity IDs, Strava owner IDs, and GeoJSON data of intersecting waterways. ğŸŒŠğŸš´â€â™‚ï¸
    columns:
      - name: datetime
        description: "Timestamp of the event ğŸ•’"
      - name: strava_activity_id
        description: "ID of the Strava activity ğŸš´â€â™‚ï¸"
      - name: strava_owner_id
        description: "ID of the Strava owner ğŸ‘¤"
      - name: intersecting_waterways
        description: "GeoJSON data of intersecting waterways crossed ğŸŒ"
      - name: polyline
        description: "Polyline of the route ğŸš´â€â™‚ï¸"
      - name: crossings
        description: "Number of crossings ğŸŒŠ"

  - name: borders
    description: >
      Parses the geojson data of country borders. Each row represents a country border and a RTREE index is created on the geom column. ğŸŒ
    columns:
      - name: country
        description: "Name of the country ğŸ—£ï¸"
      - name: geom
        description: "Geometry of the country border ğŸŒ"

  - name: ways
    description: >
      This table stores events of osm ways tagged with "waterway=*" being crossed. Each row represents a unique crossing event. ğŸŒ
    columns:
      - name: id
        description: "OSM ID of the way ğŸ†”"
      - name: strava_activity_id
        description: "ID of the Strava activity ğŸš´â€â™‚ï¸"
      - name: strava_owner_id
        description: "ID of the Strava owner ğŸ‘¤"
      - name: name
        description: "Name of the waterway ğŸ—£ï¸"
      - name: properties
        description: "Properties from OSM ğŸ“"
      - name: geom
        description: "Geometry of the waterway ğŸŒ"
  
  - name: relations
    description: >
      This model enriches osm relations tagged with "waterway=*" which do not exist in the relations table. ğŸ¥­
    columns:
      - name: id
        description: "internal OSM ID of the relation with format `relation/{id}` ğŸ†”"
      - name: osm_id
        description: "OSM ID of the relation ğŸ†”"
      - name: strava_activity_id
        description: "ID of the Strava activity ğŸš´â€â™‚ï¸"
      - name: strava_owner_id
        description: "ID of the Strava owner ğŸ‘¤"
      - name: name
        description: "Name of the waterway relation ğŸ—£ï¸"
      - name: properties
        description: "Properties from OSM ğŸ“"
      - name: geom
        description: "Geometry of the waterway relation ğŸŒ"

  - name: new_relations
    description: >
      This model contains fresh osm relations tagged with "waterway=*" not seen before.  ğŸ¥­
    columns:
      - name: id
        description: "Internal id of the relation with format `relation/{id}` ğŸ†”"
      - name: name
        description: "Name of the waterway relation ğŸ—£ï¸"
      - name: properties
        description: "Properties from OSM ğŸ“"
      - name: geom
        description: "Geometry of the waterway relation ğŸ—ºï¸"
      - name: osm_id
        description: "OSM ID of the relation ğŸ†”"
      - name: continent
        description: "Continent of the waterway ğŸŒ"
  
  - name: synthetic_relations
    description: >
      Contains events of waterways tagged with "waterway=*" being crossed. Each row represents a unique crossing event. ğŸŒ

      A synthetic relation is a MultiLineString created by combining LineString features (ways) sharing the same name. This provides a comprehensive representation of fragmented waterways in OSM data. Synthetic relations are used alongside intersecting relations to update activity descriptions with detailed waterway information.

      Notes:
      - Foolishly combines ways with the same name into a MultiLineString.
      - Assigns unique IDs in the format `syntheticRelation/{id}`.
      - Only includes waterways in the bounding box of the activity, therefore synthetic relations are often incomplete.
      - Filters out synthetic relations with matching name to legit OSM relations crossed. Attempt to avoid duplication.
    columns:
      - name: id
        description: "Internal id of the relation with format `relation/{id}` ğŸ†”"
      - name: strava_activity_id
        description: "ID of the Strava activity ğŸš´â€â™‚ï¸"
      - name: strava_owner_id
        description: "ID of the Strava owner ğŸ‘¤"
      - name: name
        description: "Name of the waterway relation ğŸ—£ï¸"
      - name: properties
        description: "Properties from OSM ğŸ“"
      - name: geom
        description: "Geometry of the waterway relation ğŸŒ"

  - name: owner
    description: >
      This model aggregates data to provide a summary of activities per Strava user. It calculates the total number of distinct activities and the sum of rivers crossed by each user. ğŸ‘¤ğŸš´â€â™‚ï¸ğŸŒŠ
    columns:
      - name: strava_owner_id
        description: "ID of the Strava owner ğŸ‘¤"
      - name: total_activities
        description: "Total number of distinct activities by the owner ğŸš´â€â™‚ï¸"
      - name: total_rivers_crossed
        description: "Total number of rivers crossed by the owner ğŸŒŠ"

  - name: country
    description: >
      This model aggregates data to provide a summary of rivers crossed per country. It calculates the total number of rivers crossed in each country. ğŸŒğŸŒŠ
    columns:
      - name: country
        description: "Name of the country ğŸ‡²ğŸ‡°"
      - name: total_waterways_crossed
        description: "Total number of waterways crossed in the country ğŸŒŠ"
      - name: total_crossings
        description: "Total number of activities in the country ğŸš´â€â™‚ï¸"
      - name: total_activities
        description: "Total number of distinct activities in the country ğŸš´â€â™‚ï¸"

  - name: nominatim_relations
    description: >
      This is a python model that fetches and stores data from the Nominatim API for new relations. It uses friendly rate limiting to be kind to the OSM servers. ğŸŒ
    columns:
      - name: osm_id
        description: "OSM ID of the feature ğŸ†”"
      - name: nominatim_response
        description: "Response data from the Nominatim API ğŸ“"

  - name: stats
    description: >
      Aggregates various counts related to countries, relations, Strava users, and activities. This model provides a summary of the data available in the project.
    columns:
      - name: count_of_countries
        description: "Count of countries with waterways crossed ğŸŒ"
      - name: count_of_relations
        description: "Count of OSM relations ğŸ†”"
      - name: count_of_strava_users
        description: "Count of Strava users ğŸ‘¤"
      - name: count_of_strava_activities
        description: "Count of distinct Strava activities ğŸš´â€â™‚ï¸"
      - name: count_of_relation_crossing
        description: "Count of relation crossings ğŸŒŠ"

seeds:
- name: country_codes
  description: >
    Raw CSV from [github](https://github.com/lukes/ISO-3166-Countries-with-Regional-Codes/blob/master/all/all.csv)

sources:
  - name: external
    description: >
      These sources are external to the project and are fetched from the world wide web ğŸ–¥ï¸
    tables:
      - name: raw_borders
        description: >
          Raw GEOJSON data of whole world country borders distributed by [datahub.io](https://datahub.io/core/geo-countries). The data is fetched from [https://r2.datahub.io/clvyjaryy0000la0cxieg4o8o/master/raw/data/countries.geojson](https://datahub.io/core/geo-countries) with [licensing](https://opendatacommons.org/licenses/pddl/).
        config:
          external_location: "st_read('https://r2.datahub.io/clvyjaryy0000la0cxieg4o8o/master/raw/data/countries.geojson')"
      
  
  - name: kreuzungen
    description: >
      Events are created when a new Strava activity is created and the webhook notifies Kreuzungen. The `processAndUpdateStrava` function calculates intersecting waterways using the activity's summary polyline and stores the resulting data in the S3 bucket. This includes the timestamp, Strava activity ID, Strava owner ID, polyline, and GeoJSON data of intersecting waterways.
    freshness:
      warn_after: {count: 1, period: hour}
      error_after: {count: 6, period: hour}
    loaded_at_field:  CAST(datetime AS TIMESTAMP)
    tables:
      - name: raw_waterways
        description: >
          Raw JSON data of waterways intersected by user activities. This data is fetched from an Tigris S3 bucket. Each row is a json file including strava data and geometries 
          and other properties. ğŸŒŠğŸ“Š
        config:
          external_location: "read_json('s3://hydro-xpid/events/*.json')"
        loader: "s3://hydro-xpid/events/*.json"
        columns:
          - name: datetime
            description: "Timestamp of the event ğŸ•’"
          - name: strava_activity_id
            description: "ID of the Strava activity ğŸš´â€â™‚ï¸"
          - name: strava_owner_id
            description: "ID of the Strava owner ğŸ‘¤"
          - name: polyline
            description: "Polyline of the route ğŸ—ºï¸ LineString of Strava activity encoded with the [polyline algorithm](https://developers.google.com/maps/documentation/utilities/polylinealgorithm)"
          - name: intersecting_waterways
            description: "GeoJSON data of intersecting waterways ğŸŒ"


exposures:
  - name: kreuzungen
    type: dashboard
    maturity: high
    url: https://kreuzungen.world
    description: >
      Powers the globe visualization of waterways crossed. ğŸŒğŸš´â€â™‚ï¸ğŸŒŠ
    depends_on:
      - ref('country')
      - ref('stats')
    owner:
      name: Dave
      email: contact@kreuzungen.world
